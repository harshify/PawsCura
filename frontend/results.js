// DOM Elements
const resultImage = document.getElementById('resultImage');
const statusBadge = document.getElementById('statusBadge');
const predictionResult = document.getElementById('predictionResult');
const confidenceBar = document.getElementById('confidenceBar');
const confidenceValue = document.getElementById('confidenceValue');
const diseaseDescription = document.getElementById('diseaseDescription');
const remediesList = document.getElementById('remediesList');
const hamburgerMenu = document.querySelector('.hamburger-menu');
const mobileMenu = document.querySelector('.mobile-menu');
const downloadButton = document.getElementById('downloadButton');

// Event Listeners
hamburgerMenu.addEventListener('click', toggleMobileMenu);
downloadButton.addEventListener('click', downloadPDF);

// Mobile Menu Functionality
function toggleMobileMenu() {
    mobileMenu.classList.toggle('hidden');
}

// Close mobile menu when clicking outside
document.addEventListener('click', (event) => {
    if (!mobileMenu.contains(event.target) && !hamburgerMenu.contains(event.target) && !mobileMenu.classList.contains('hidden')) {
        mobileMenu.classList.add('hidden');
    }
});

// PDF Download Functionality
function downloadPDF() {
    // Create the content for PDF
    const prediction = predictionResult.textContent;
    const confidence = confidenceValue.textContent;
    const description = diseaseDescription.textContent;

    // Get remedies list content
    let remediesText = '';
    const remediesItems = remediesList.querySelectorAll('li');
    remediesItems.forEach((item, index) => {
        const remedyText = item.querySelector('span:last-child').textContent;
        remediesText += `${index + 1}. ${remedyText}\n`;
    });

    // Create a blob with the content
    let content = `
        PawsCura - Dog Skin Health Analysis Results
        ===========================================
        
        Diagnosis: ${prediction}
        Confidence: ${confidence}
        
        About This Condition:
        ${description}
        
        Recommended Actions:
        ${remediesText}
        
        -----------------------------------------------
        Generated by PawsCura on ${new Date().toLocaleDateString()}
        Visit us at www.pawscura.com
    `;

    const blob = new Blob([content], {type: 'text/plain'});
    const url = URL.createObjectURL(blob);
    
    // Create a temporary link and trigger download
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;
    a.download = `PawsCura-Results-${new Date().toLocaleDateString().replace(/\//g, '-')}.txt`;
    document.body.appendChild(a);
    a.click();
    
    // Clean up
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
}

// Parse query parameters
function getQueryParams() {
    const params = {};
    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    
    for (const [key, value] of urlParams.entries()) {
        params[key] = value;
    }
    
    return params;
}

// Display results on page load
window.addEventListener('DOMContentLoaded', async () => {
    const params = getQueryParams();
    
    // If no prediction in URL, redirect back to home
    if (!params.prediction) {
        window.location.href = 'index.html';
        return;
    }
    
    // Get image from localStorage instead of URL parameters
    const storedImage = localStorage.getItem('pawscura_image');
    if (storedImage) {
        resultImage.src = storedImage;
        // Clear storage after using it
        localStorage.removeItem('pawscura_image');
    } else {
        // Fallback - show a generic dog image
        resultImage.src = './images/dog-pic-1.jpg';
        console.log('No image data found in storage');
    }
    
    // Set the prediction result
    predictionResult.textContent = decodeURIComponent(params.prediction);
    
    // Set confidence level (default to 90% if not provided)
    const confidence = params.confidence || 90;
    confidenceBar.style.width = `${confidence}%`;
    confidenceValue.textContent = `${confidence}%`;
    
    // Set status badge color and text based on prediction
    const prediction = decodeURIComponent(params.prediction);
    let statusClass = '';
    let statusText = '';
    let confidenceBarColor = '';
    
    if (prediction.includes('Healthy')) {
        statusClass = 'bg-green-800 text-green-100';
        statusText = 'Healthy';
        confidenceBarColor = 'bg-green-500';
    } else if (prediction.includes('Bacterial')) {
        statusClass = 'bg-red-800 text-red-100';
        statusText = 'Attention Needed';
        confidenceBarColor = 'bg-red-500';
    } else if (prediction.includes('Fungal')) {
        statusClass = 'bg-orange-800 text-orange-100';
        statusText = 'Attention Needed';
        confidenceBarColor = 'bg-orange-500';
    } else {
        statusClass = 'bg-blue-800 text-blue-100';
        statusText = 'Analysis Complete';
        confidenceBarColor = 'bg-blue-500';
    }
    
    // Apply the styles
    statusBadge.className = `px-4 py-2 rounded-full text-sm font-semibold ${statusClass}`;
    statusBadge.textContent = statusText;
    confidenceBar.className = `h-2.5 rounded-full ${confidenceBarColor}`;
    
    // Get disease description and remedies from the API
    try {
        const response = await fetch(`/disease-info?disease=${encodeURIComponent(prediction)}`);
        if (response.ok) {
            const data = await response.json();
            
            // Update description
            diseaseDescription.textContent = data.description || 'No information available.';
            
            // Update remedies list
            if (data.remedies && data.remedies.length > 0) {
                remediesList.innerHTML = '';
                data.remedies.forEach(remedy => {
                    const li = document.createElement('li');
                    li.className = 'flex items-start';
                    li.innerHTML = `
                        <span class="flex-shrink-0 w-5 h-5 bg-indigo-900 text-indigo-300 rounded-full flex items-center justify-center mr-3 mt-0.5">
                            <i class="fas fa-check text-xs"></i>
                        </span>
                        <span class="text-gray-300">${remedy}</span>
                    `;
                    remediesList.appendChild(li);
                });
            } else {
                setDefaultRemedies(prediction);
            }
        } else {
            handleDiseaseInfoError(prediction);
        }
    } catch (error) {
        console.error('Error fetching disease information:', error);
        handleDiseaseInfoError(prediction);
    }
});

// Fallback function for when API fails
function handleDiseaseInfoError(prediction) {
    // Set the description and remedies based on the prediction
    setDefaultDescription(prediction);
    setDefaultRemedies(prediction);
}

// Set default description
function setDefaultDescription(prediction) {
    let description = 'Information could not be retrieved. Please consult a veterinarian for proper diagnosis and treatment.';
    
    if (prediction.includes('Bacterial')) {
        description = 'Bacterial dermatitis is a skin infection caused by bacteria. It often presents as red, inflamed areas that may have discharge or crusting. In dogs, it\'s commonly caused by Staphylococcus bacteria, which can enter through breaks in the skin due to scratching, allergies, or other irritations. Symptoms include redness, itching, hair loss, pustules, and in some cases, an unpleasant odor.';
    } else if (prediction.includes('Fungal')) {
        description = 'Fungal skin infections in dogs are commonly caused by dermatophytes (ringworm) or yeast (Malassezia). They typically appear as circular lesions, scaly patches, or itchy, inflamed skin. Ringworm is contagious to humans and other pets, while yeast infections often develop in moist areas like skin folds, ears, and paws. Both can cause intense itching, hair loss, and discomfort for your pet.';
    } else if (prediction.includes('Healthy')) {
        description = 'Your dog\'s skin appears healthy with no visible signs of disease. Healthy dog skin is typically smooth, with good elasticity and no excessive flaking, redness, or irritation. The coat should be shiny and without bald patches. Maintaining skin health is important as the skin acts as a barrier against infections and environmental hazards.';
    }
    
    diseaseDescription.textContent = description;
}

// Set default remedies
function setDefaultRemedies(prediction) {
    let remedies = [];
    
    if (prediction.includes('Bacterial')) {
        remedies = [
            'Consult a veterinarian for proper diagnosis and prescription antibiotics',
            'Keep the affected area clean and dry',
            'Use veterinarian-recommended medicated shampoos',
            'Prevent your dog from licking or scratching the affected area',
            'Address any underlying allergies or skin conditions'
        ];
    } else if (prediction.includes('Fungal')) {
        remedies = [
            'Consult a veterinarian for proper diagnosis and antifungal medication',
            'Isolate your pet to prevent spread to other animals or humans if ringworm is suspected',
            'Use medicated shampoos specifically formulated for fungal infections',
            'Keep your dog\'s living environment clean and disinfected',
            'Make sure to complete the full course of prescribed treatment even if symptoms improve'
        ];
    } else if (prediction.includes('Healthy')) {
        remedies = [
            'Continue regular grooming and skin checks',
            'Maintain a balanced diet rich in omega fatty acids for skin health',
            'Regular bathing with dog-appropriate shampoo (not human shampoo)',
            'Schedule routine veterinary check-ups',
            'Provide flea and tick prevention as recommended by your vet'
        ];
    } else {
        remedies = [
            'Consult a veterinarian for proper diagnosis',
            'Take clear photos of the affected areas to show your vet',
            'Note any changes in your dog\'s behavior or comfort level',
            'Prevent your dog from scratching or licking the affected area',
            'Follow your veterinarian\'s treatment recommendations'
        ];
    }
    
    remediesList.innerHTML = '';
    remedies.forEach(remedy => {
        const li = document.createElement('li');
        li.className = 'flex items-start';
        li.innerHTML = `
            <span class="flex-shrink-0 w-5 h-5 bg-indigo-900 text-indigo-300 rounded-full flex items-center justify-center mr-3 mt-0.5">
                <i class="fas fa-check text-xs"></i>
            </span>
            <span class="text-gray-300">${remedy}</span>
        `;
        remediesList.appendChild(li);
    });
} 